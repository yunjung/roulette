<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5899C1DJM0"></script>

  <title>Marble Roulette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" sizes="57x57" href="assets/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="assets/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="assets/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="assets/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="assets/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="assets/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="manifest" href="assets/manifest.json">

  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="assets/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <meta name="description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:url" content="https://lazygyu.github.io/roulette/">
  <meta property="og:title" content="Marble Roulette">
  <meta property="og:description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:site_name" content="lazygyu.github.io">
  <meta property="og:type" content="website">

  <link rel='stylesheet' href='assets/style.scss' />
</head>
<body>
<script type="module" src="./src/index.ts"></script>
<script type="text/javascript">
  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }

  gtag('js', new Date());
  gtag('config', 'G-5899C1DJM0');

  function getNames() {
    const value = document.querySelector('#in_names').value.trim();
    return value.split(/[,\r\n]/g).map(v => v.trim()).filter(v => !!v);
  }

  function parseName(nameStr) {
    const weightRegex = /(\/\d+)/;
    const countRegex = /(\*\d+)/;
    const hasWeight = weightRegex.test(nameStr);
    const hasCount = countRegex.test(nameStr);
    const name = /^\s*([^\/*]+)?/.exec(nameStr)[1];
    const weight = hasWeight ? parseInt(weightRegex.exec(nameStr)[1].replace('/', '')) : 1;
    const count = hasCount ? parseInt(countRegex.exec(nameStr)[1].replace('*', '')) : 1;
    return {
      name,
      weight,
      count,
    };
  }

  function getReady() {
    const names = getNames();
    window.roulette.setMarbles(names);
    ready = names.length > 0;
    localStorage.setItem('mbr_names', names.join(','));

    // Update winner ranks based on current input value
    const input = document.querySelector('#in_winnerPositions').value.trim();
    if (input) {
      const ranks = input.split(',').map(v => parseInt(v.trim(), 10)).filter(v => !isNaN(v) && v > 0).slice(0, 5); // Max 5 winners
      if (ranks.length > 0) {
        setWinnerRanks(ranks);
      }
    }
  }

  function setWinnerRanks(ranks) {
    // Convert to 0-indexed and store
    const zeroIndexedRanks = ranks.map(r => r - 1);
    window.options.winningRanks = zeroIndexedRanks;
    window.options.winningRank = Math.max(...zeroIndexedRanks);
    window.roulette.setWinningRanks(zeroIndexedRanks);
  }

  function setWinnerRank(rank) {
    document.querySelector('#in_winnerPositions').value = rank;
    setWinnerRanks([rank]);
  }


  let ready = false;

  document.addEventListener('DOMContentLoaded', () => {
    initialize();
  });

  function initialize() {
    if (!window.roulette || !window.roulette.isReady) {
      console.log('does not loaded yet');
      setTimeout(initialize, 100);
      return;
    }
    console.log('initializing start');

    const urlParams = new URLSearchParams(window.location.search);
    const namesFromUrl = urlParams.get('names');

    if (namesFromUrl) {
      document.querySelector('#in_names').value = namesFromUrl.replace(/,/g, '\n');
    }
    // Skip localStorage loading for testing - always use default вБевЈїьћё1~50
    document.querySelector('#in_names').addEventListener('input', () => {
      getReady();
    });

    document.querySelector('#in_names').addEventListener('blur', () => {
      const nameSource = getNames();
      const nameSet = new Set();
      const nameCounts = {};
      nameSource.forEach(nameSrc => {
        const name = parseName(nameSrc);
        const key = name.weight > 1 ? `${name.name}/${name.weight}` : name.name;
        if (!nameSet.has(key)) {
          nameSet.add(key);
          nameCounts[key] = 0;
        }
        nameCounts[key] += name.count;
      });
      const result = [];
      Object.keys(nameCounts).forEach(key => {
        if (nameCounts[key] > 1) {
          result.push(`${key}*${nameCounts[key]}`);
        } else {
          result.push(key);
        }
      });

      const oldValue = document.querySelector('#in_names').value;
      const newValue = result.join(',');

      if (oldValue !== newValue) {
        document.querySelector('#in_names').value = newValue;
        getReady();
      }
    });

    document.querySelector('#btnShuffle').addEventListener('click', () => {
      getReady();
    });

    document.querySelector('#btnStart').addEventListener('click', () => {
      if (!ready) return;
      gtag && gtag('event', 'start', {
        'event_category': 'roulette',
        'event_label': 'start',
        'value': window.roulette.getCount(),
      });
      window.roulette.start();
      document.querySelector('#settings').classList.add('hide');
    });

    document.querySelector('#chkAutoRecording').addEventListener('change', (e) => {
      window.options.autoRecording = e.target.matches(':checked');
      window.roulette.setAutoRecording(window.options.autoRecording);
    });

    document.querySelector('#chkAudio').addEventListener('change', (e) => {
      const enabled = e.target.matches(':checked');
      window.roulette.setAudioMuted(!enabled);
    });

    document.querySelector('#chkSkill').addEventListener('change', (e) => {
      window.options.useSkills = e.target.matches(':checked');
      window.roulette.setWinningRank(window.options.winningRank);
    });

    // Enable Christmas theme by default
    window.roulette.setTheme('christmas');
    window.roulette.enableSnow();

    document.querySelector('#chkDarkMode').addEventListener('change', (e) => {
      const useChristmas = e.target.matches(':checked');
      window.roulette.setTheme(useChristmas ? 'christmas' : 'dark');
      if (useChristmas) {
        window.roulette.enableSnow();
      } else {
        window.roulette.disableSnow();
      }
    });

    document.querySelector('#in_winnerPositions').addEventListener('input', (e) => {
      const input = e.target.value.trim();
      if (!input) return;

      // Parse comma-separated values (max 5 winners)
      const ranks = input.split(',').map(v => parseInt(v.trim(), 10)).filter(v => !isNaN(v) && v > 0).slice(0, 5);

      if (ranks.length > 0) {
        setWinnerRanks(ranks);
      }
    });

    window.roulette.addEventListener('goal', () => {
      ready = false;
      setTimeout(() => {
        document.querySelector('#settings').classList.remove('hide');
      }, 3000);
    });

    window.roulette.addEventListener('message', (e) => {
      simpleToast(e.detail);
    });

    document.querySelector('#btnShuffle').click();

    const maps = window.roulette.getMaps();
    const mapSelector = document.querySelector('#sltMap');
    maps.forEach((map) => {
      const option = document.createElement('option');
      option.value = map.index;
      option.innerHTML = map.title;
      option.setAttribute('data-trans', '');
      window.translateElement(option);
      mapSelector.append(option);
    });
    mapSelector.addEventListener('change', (e) => {
      const index = e.target.value;
      window.roulette.setMap(index);
    });



  }
</script>
<div id="settings" class="settings">
  <div class="right">
    <div class="row">
      <label for='sltMap'>
        <i class="icon map"></i>
        <span data-trans>Map</span>
      </label>
      <select id="sltMap"></select>
    </div>
    <div class="row">
      <label for='chkAutoRecording'>
        <i class="icon record"></i>
        <span data-trans>Recording</span>
      </label>
      <input type="checkbox" id="chkAutoRecording" />
    </div>
    <div class="row">
      <label for='chkAudio'>
        <span style="font-size: 16px;">­Ъћі</span>
        <span data-trans>Sound</span>
      </label>
      <input type="checkbox" id="chkAudio" checked />
    </div>
    <div class="row">
      <label for='in_winnerPositions'>
        <i class="icon trophy"></i>
        <span data-trans>Winner position(s)</span>
      </label>
      <input type="text" id="in_winnerPositions" value="1" placeholder="e.g., 1 or 1,3,5" />
    </div>
    <div class="row">
      <label for='chkSkill'>
        <i class="icon bomb"></i>
        <span data-trans>Using skills</span>
      </label>
      <input type="checkbox" id="chkSkill" checked />
      <div class='theme'>
        <span style="font-size: 20px;">­ЪїЎ</span>
        <input type='checkbox' id='chkDarkMode' checked />
        <span style="font-size: 20px;">­Ъјё</span>
      </div>
    </div>
  </div>
  <div class="left">
    <h3 data-trans>Enter names below</h3>
    <textarea id="in_names" placeholder="Input names separated by commas or line feed here" data-trans="placeholder">вБевЈїьћё1,вБевЈїьћё2,вБевЈїьћё3,вБевЈїьћё4,вБевЈїьћё5,вБевЈїьћё6,вБевЈїьћё7,вБевЈїьћё8,вБевЈїьћё9,вБевЈїьћё10,вБевЈїьћё11,вБевЈїьћё12,вБевЈїьћё13,вБевЈїьћё14,вБевЈїьћё15,вБевЈїьћё16,вБевЈїьћё17,вБевЈїьћё18,вБевЈїьћё19,вБевЈїьћё20,вБевЈїьћё21,вБевЈїьћё22,вБевЈїьћё23,вБевЈїьћё24,вБевЈїьћё25,вБевЈїьћё26,вБевЈїьћё27,вБевЈїьћё28,вБевЈїьћё29,вБевЈїьћё30,вБевЈїьћё31,вБевЈїьћё32,вБевЈїьћё33,вБевЈїьћё34,вБевЈїьћё35,вБевЈїьћё36,вБевЈїьћё37,вБевЈїьћё38,вБевЈїьћё39,вБевЈїьћё40,вБевЈїьћё41,вБевЈїьћё42,вБевЈїьћё43,вБевЈїьћё44,вБевЈїьћё45,вБевЈїьћё46,вБевЈїьћё47,вБевЈїьћё48,вБевЈїьћё49,вБевЈїьћё50</textarea>
    <div class="actions">

      <button id="btnShuffle">
        <i class="icon shuffle"></i>
        <span data-trans>Shuffle</span>
      </button>
      <button id="btnStart">
        <i class="icon play"></i>
        <span data-trans>Start</span>
      </button>
    </div>
  </div>
</div>

<div class="copyright">&copy; 2022-2025.<a href="https://lazygyu.net" target="_blank">lazygyu</a> <span data-trans>This program is freeware and may be used freely anywhere, including in broadcasts and videos.</span>
</div>
</body>
</html>
